<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cartoon Clash Arena - Mobile</title>
  <style>
    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      background:
        radial-gradient(circle at top left, #ffe082 0, transparent 55%),
        radial-gradient(circle at top right, #a5b4fc 0, transparent 55%),
        radial-gradient(circle at bottom, #6ee7b7 0, #0f172a 80%);
      color: #0f172a;
    }

    .app-shell {
      width: 100%;
      max-width: 1120px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .topbar {
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      backdrop-filter: blur(10px);
      background: rgba(15,23,42,0.9);
      color: #f9fafb;
      box-shadow: 0 3px 10px rgba(0,0,0,0.35);
      position: sticky;
      top: 0;
      z-index: 20;
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-pill {
      width: 44px;
      height: 44px;
      border-radius: 999px;
      background: conic-gradient(from 180deg, #f97316, #facc15, #22c55e, #3b82f6, #f97316);
      padding: 2px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.35);
    }

    .logo-pill-inner {
      width: 100%;
      height: 100%;
      border-radius: inherit;
      background: radial-gradient(circle at 30% 0, #ffffff 0, #e5e7eb 30%, #0f172a 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      font-size: 22px;
      color: #111827;
    }

    .topbar-title h1 {
      margin: 0;
      font-size: 20px;
    }

    .topbar-title div {
      font-size: 12px;
      color: #e5e7eb;
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
    }

    .chip {
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.7);
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .hud {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding: 6px 12px 4px 12px;
      font-size: 11px;
      color: #0f172a;
    }

    .hud-chip {
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(248,250,252,0.9);
      border: 1px solid rgba(148,163,184,0.6);
      box-shadow: 0 1px 4px rgba(15,23,42,0.2);
    }

    .page {
      flex: 1;
      padding: 6px 12px 18px 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .mobile-section {
      margin-bottom: 8px;
    }

    .card {
      background: rgba(248,250,252,0.96);
      border-radius: 18px;
      padding: 10px 12px;
      margin-bottom: 8px;
      box-shadow: 0 4px 14px rgba(15,23,42,0.15);
      border: 1px solid rgba(148,163,184,0.55);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: radial-gradient(circle at top left, rgba(255,255,255,0.7) 0, transparent 60%);
      opacity: 0.7;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
      position: relative;
      z-index: 1;
    }

    .card-header h2 {
      margin: 0;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .card-header h2 span.icon {
      font-size: 15px;
    }

    .card-header-tag {
      font-size: 10px;
      padding: 2px 7px;
      border-radius: 999px;
      background: #e5e7eb;
      color: #4b5563;
      border: 1px solid #cbd5f5;
    }

    .card-body {
      position: relative;
      z-index: 1;
      font-size: 12px;
    }

    button {
      border: none;
      padding: 6px 10px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 600;
      margin: 3px 3px 0 0;
      background: linear-gradient(135deg,#f97316,#facc15);
      color: #111827;
      box-shadow: 0 2px 5px rgba(0,0,0,0.18);
      transition: transform 0.05s ease, box-shadow 0.1s ease, filter 0.1s ease;
      font-size: 11px;
    }

    button.secondary {
      background: linear-gradient(135deg,#38bdf8,#0ea5e9);
      color: #0b1020;
    }

    button.danger {
      background: linear-gradient(135deg,#ef4444,#f97316);
      color: #fff;
    }

    button:disabled {
      opacity: 0.5;
      cursor: default;
    }

    button:not(:disabled):active {
      transform: translateY(1px);
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      filter: brightness(0.96);
    }

    .stat-list {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 3px 10px;
      font-size: 13px;
      margin-top: 4px;
    }

    .label { font-weight: 600; }

    #log {
      background: radial-gradient(circle at top, #020617 0, #020617 40%, #0b1120 100%);
      color: #e5e7eb;
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      padding: 6px;
      border-radius: 12px;
      height: 150px;
      overflow-y: auto;
      border: 1px solid #1f2937;
    }

    .log-line { margin-bottom: 2px; }
    .log-system { color: #e5e7eb; }
    .log-hero { color: #a5f3fc; }
    .log-enemy { color: #fca5a5; }
    .log-crit { color: #facc15; font-weight: 700; }
    .log-round { color: #9ca3af; font-style: italic; }
    .log-loot { color: #bbf7d0; }

    .badge {
      display: inline-block;
      padding: 2px 7px;
      border-radius: 999px;
      background: #fffbeb;
      font-size: 10px;
      margin-left: 4px;
      color: #92400e;
      font-weight: 700;
      border: 1px solid #fed7aa;
    }

    .hero-meta {
      font-size: 12px;
      margin-top: 2px;
      color: #374151;
    }

    /* === AVATAR / PERSONNAGE CARTOON === */

    .avatar-wrapper {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 6px;
    }

    .paperdoll-container {
      width: 120px;
      height: 150px;
      position: relative;
    }

    .paperdoll {
      width: 100%;
      height: 100%;
      border-radius: 18px;
      background: radial-gradient(circle at top, #1e293b 0, #020617 60%);
      box-shadow: 0 4px 10px rgba(15,23,42,0.5);
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(148,163,184,0.8);
    }

    .avatar-svg {
      width: 100%;
      height: 100%;
      display: block;
    }

    .doll-slot {
      position: absolute;
      width: 26px;
      height: 26px;
      border-radius: 9px;
      border: 2px solid #6b7280;
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.6);
    }

    .doll-slot-helmet { top: 3px; left: 50%; transform: translateX(-50%); }
    .doll-slot-weapon { top: 28px; left: 3px; }
    .doll-slot-armor  { top: 48px; right: 3px; }
    .doll-slot-boots  { bottom: 6px; left: 10px; }
    .doll-slot-accessory { bottom: 6px; right: 10px; }

    .hero-summary {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .hero-summary button {
      padding: 4px 8px;
      font-size: 11px;
      margin-top: 2px;
    }

    .hp-block { margin-top: 6px; font-size: 11px; }

    .hp-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .hp-bar-outer {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: #111827;
      margin-top: 2px;
      overflow: hidden;
    }

    .hp-bar-inner {
      height: 100%;
      width: 100%;
      background: linear-gradient(90deg, #22c55e, #a3e635);
      transition: width 0.2s ease;
    }

    .hp-bar-inner.enemy {
      background: linear-gradient(90deg, #f97316, #ef4444);
    }

    .hp-combat-row {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }

    .hp-combat-row .hp-block { flex: 1; }

    .enemy-avatar {
      background: linear-gradient(135deg, #ef4444, #f97316);
    }

    .enemy-card {
      background: radial-gradient(circle at top, #020617 0, #0b1120 60%);
      color: #e5e7eb;
      border-color: #1f2937;
    }

    .enemy-card .card-header h2 { color: #e5e7eb; }
    .enemy-card .card-header-tag {
      background: rgba(15,23,42,0.7);
      color: #e5e7eb;
      border-color: #1f2937;
    }

    .enemy-stats { font-size: 11px; margin-top: 4px; color: #9ca3af; }

    .pill {
      display: inline-block;
      padding: 2px 7px;
      border-radius: 999px;
      background: rgba(15,23,42,0.4);
      font-size: 11px;
      margin-right: 4px;
      margin-top: 2px;
    }

    .shop-note { font-size: 12px; color: #4b5563; margin-top: 4px; }

    .arena-rank { font-weight: 600; }

    .arena-rank-badge {
      display: inline-block;
      padding: 2px 7px;
      border-radius: 999px;
      font-size: 11px;
      margin-left: 4px;
      background: #e5e7eb;
      color: #111827;
    }

    .skip-line {
      margin-top: 4px;
      font-size: 11px;
      color: #4b5563;
    }

    .skip-line input { margin-right: 4px; }

    #inventoryList { max-height: 400px; overflow-y: auto; }

    .bottom-nav {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      height: 56px;
      background: rgba(15,23,42,0.96);
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 4px 6px;
      box-shadow: 0 -3px 10px rgba(0,0,0,0.4);
      z-index: 40;
    }

    .nav-btn {
      flex: 1;
      height: 44px;
      margin: 0 4px;
      border-radius: 999px;
      border: none;
      background: transparent;
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      gap: 2px;
      cursor: pointer;
    }

    .nav-btn span.icon { font-size: 16px; }

    .nav-btn.active {
      background: linear-gradient(135deg,#f97316,#facc15);
      color: #111827;
    }

    @media (min-width: 900px) {
      .bottom-nav { display: none; }
      .mobile-section { display: block !important; }
      .page { padding-bottom: 18px; }
    }

    @media (max-width: 899px) {
      .mobile-section { display: none; }
      .mobile-section.active { display: block; }
      .chip { display: none; }
      .page { padding-bottom: 80px; }
    }

    .dev-btn {
      position: fixed;
      right: 14px;
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      color: #facc15;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.35);
      cursor: pointer;
      z-index: 60;
      opacity: 0.6;
      transition: opacity 0.15s ease, transform 0.1s ease;
      bottom: 14px;
    }

    .dev-btn:hover {
      opacity: 1;
      transform: translateY(-1px);
    }

    .dev-panel {
      position: fixed;
      right: 14px;
      width: 230px;
      border-radius: 16px;
      background: rgba(15,23,42,0.97);
      color: #e5e7eb;
      padding: 10px 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.45);
      font-size: 12px;
      z-index: 65;
      display: none;
      bottom: 62px;
    }

    .dev-panel.open { display: block; }

    .dev-panel h3 {
      margin: 0 0 4px 0;
      font-size: 13px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .dev-panel small {
      display: block;
      margin-bottom: 6px;
      color: #9ca3af;
    }

    .dev-panel button {
      margin: 3px 3px 0 0;
      padding: 5px 8px;
      font-size: 11px;
    }

    #devGodState {
      font-weight: 700;
      margin-left: 4px;
    }

    @media (max-width: 899px) {
      .dev-btn { bottom: 74px; }
      .dev-panel { bottom: 126px; }
    }

    .mode-toggle {
      display: flex;
      gap: 4px;
      margin-bottom: 6px;
    }

    button.mode-btn {
      flex: 1;
      padding: 5px 6px;
      font-size: 11px;
      background: #e5e7eb;
      color: #111827;
      box-shadow: none;
    }

    button.mode-btn.active {
      background: linear-gradient(135deg,#f97316,#facc15);
      box-shadow: 0 2px 5px rgba(0,0,0,0.18);
    }

    /* === OVERLAY CR√âATION H√âROS === */

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .overlay.hidden { display: none; }

    .overlay-inner {
      width: 90%;
      max-width: 360px;
      background: #0b1120;
      color: #e5e7eb;
      border-radius: 18px;
      padding: 14px 16px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.6);
      border: 1px solid #1f2937;
    }

    .overlay-inner h2 {
      margin: 0 0 4px 0;
      font-size: 18px;
    }

    .overlay-inner p {
      margin: 0 0 8px 0;
      font-size: 13px;
      color: #9ca3af;
    }

    .overlay-inner input {
      width: 100%;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #f9fafb;
      margin-bottom: 10px;
      font-size: 13px;
    }

    .color-row {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }

    .color-choice {
      flex: 1;
      height: 34px;
      border-radius: 999px;
      border: 2px solid transparent;
      cursor: pointer;
      padding: 0;
      box-shadow: 0 3px 10px rgba(0,0,0,0.5);
    }

    .color-choice.selected {
      border-color: #fde68a;
      box-shadow: 0 0 0 1px #facc15, 0 3px 10px rgba(0,0,0,0.7);
    }

    .overlay-inner button {
      width: 100%;
      margin: 0;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="topbar">
      <div class="topbar-left">
        <div class="logo-pill">
          <div class="logo-pill-inner">C</div>
        </div>
        <div class="topbar-title">
          <h1>Cartoon Clash Arena</h1>
          <div>Version mobile, perso cartoon & cr√©ation de h√©ros. üòà</div>
        </div>
      </div>
      <div class="topbar-right">
        <div class="chip">
          <span>üíª DEV :</span>
          <span>Ctrl+Shift+C ‚Üí +100 üí∞</span>
          <span>Ctrl+Shift+M ‚Üí MAX</span>
          <span>Ctrl+Shift+G ‚Üí GOD MODE</span>
        </div>
      </div>
    </header>

    <!-- HUD -->
    <div class="hud">
      <div class="hud-chip" id="hudLevel">Niv. ‚Äî</div>
      <div class="hud-chip" id="hudXP">XP ‚Äî</div>
      <div class="hud-chip" id="hudCoins">üí∞ ‚Äî</div>
      <div class="hud-chip" id="hudArena">‚ö™ Non class√©</div>
    </div>

    <main class="page">
      <!-- √âCRAN 1 : COMBAT -->
      <section id="section-fight" class="mobile-section active">
        <div class="card">
          <div class="card-header">
            <h2><span class="icon">ü•ä</span> Mode de combat</h2>
            <div class="card-header-tag">Histoire ou Ar√®ne</div>
          </div>
          <div class="card-body">
            <div class="mode-toggle">
              <button id="mode-story" class="mode-btn active" onclick="setCombatMode('story')">
                üìñ Histoire
              </button>
              <button id="mode-arena" class="mode-btn" onclick="setCombatMode('arena')">
                üèüÔ∏è Ar√®ne
              </button>
            </div>

            <div id="storyControls">
              <div style="margin-bottom:4px;font-size:12px;font-weight:600;">
                Mode histoire (PvE)
              </div>
              <button onclick="startMission('easy')">Mission facile</button>
              <button class="secondary" onclick="startMission('normal')">Mission normale</button>
              <button class="danger" onclick="startMission('hard')">Mission difficile</button>
              <div style="margin-top:4px;font-size:11px;">
                Facile = farm chill, Normal = √©quilibr√©, Difficile = plus risqu√© mais plus rentable.
              </div>

              <div class="skip-line">
                <label>
                  <input type="checkbox" id="instantToggle" onchange="toggleInstantResolve(this)">
                  R√©soudre les combats instantan√©ment
                </label>
              </div>
            </div>

            <div id="arenaControls" style="display:none;">
              <div style="margin-bottom:4px;font-size:12px;font-weight:600;">
                Ar√®ne PvP simul√©e
              </div>
              <div id="arenaInfo" style="margin-bottom:4px;"></div>
              <button onclick="startArenaBattle()">Match d'ar√®ne</button>
              <div style="margin-top:4px;font-size:11px;">
                Affronte des profils simul√©s, gagne des points et monte de rang.
              </div>
            </div>
          </div>
        </div>

        <div class="card enemy-card">
          <div class="card-header">
            <h2><span class="icon">ü§ú</span> Adversaire & PV combat</h2>
            <div class="card-header-tag">Situation actuelle</div>
          </div>
          <div class="card-body">
            <div class="avatar-wrapper">
              <div class="paperdoll-container">
                <div class="paperdoll enemy-avatar">
                  <svg class="avatar-svg" viewBox="0 0 120 160">
                    <!-- T√™te -->
                    <circle cx="60" cy="32" r="16" fill="#fee2e2" stroke="#111827" stroke-width="2"></circle>
                    <!-- Bandeau -->
                    <rect x="48" y="26" width="24" height="6" rx="3" fill="#b91c1c"></rect>
                    <!-- Corps -->
                    <rect x="40" y="50" width="40" height="40" rx="14"
                          fill="#fecaca" stroke="#111827" stroke-width="2"></rect>
                    <!-- Bras -->
                    <rect x="28" y="54" width="10" height="32" rx="5" fill="#fecaca" stroke="#111827" stroke-width="2"></rect>
                    <rect x="82" y="54" width="10" height="32" rx="5" fill="#fecaca" stroke="#111827" stroke-width="2"></rect>
                    <!-- Jambes -->
                    <rect x="44" y="92" width="12" height="28" rx="5" fill="#111827" stroke="#111827" stroke-width="2"></rect>
                    <rect x="64" y="92" width="12" height="28" rx="5" fill="#111827" stroke="#111827" stroke-width="2"></rect>
                    <!-- Chaussures -->
                    <rect x="42" y="120" width="16" height="6" rx="3" fill="#0f172a"></rect>
                    <rect x="62" y="120" width="16" height="6" rx="3" fill="#0f172a"></rect>
                    <!-- Visage -->
                    <text x="60" y="36" text-anchor="middle" font-size="14">üò†</text>
                  </svg>
                </div>
              </div>
              <div>
                <div id="enemyInfo">Aucun ennemi pour l'instant. Lance une mission ou un match d'ar√®ne.</div>
                <div class="enemy-stats" id="enemyStats"></div>
              </div>
            </div>

            <div class="hp-block" style="margin-top:6px;">
              <div class="hp-label">
                <span>PV max ennemi</span>
                <span id="enemyHPText">‚Äî</span>
              </div>
              <div class="hp-bar-outer">
                <div id="enemyHPBarInner" class="hp-bar-inner enemy"></div>
              </div>
            </div>

            <div class="hp-combat-row" style="margin-top:6px;">
              <div class="hp-block">
                <div class="hp-label">
                  <span>Toi</span>
                  <span id="duelHeroHPText">‚Äî</span>
                </div>
                <div class="hp-bar-outer">
                  <div id="duelHeroHPBar" class="hp-bar-inner"></div>
                </div>
              </div>
              <div class="hp-block">
                <div class="hp-label">
                  <span>Ennemi</span>
                  <span id="duelEnemyHPText">‚Äî</span>
                </div>
                <div class="hp-bar-outer">
                  <div id="duelEnemyHPBar" class="hp-bar-inner enemy"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2><span class="icon">üìú</span> Journal de combat</h2>
            <div class="card-header-tag">Round par round</div>
          </div>
          <div class="card-body">
            <div id="log"></div>
          </div>
        </div>
      </section>

      <!-- √âCRAN 2 : INVENTAIRE + H√âROS -->
      <section id="section-inventory" class="mobile-section">
        <div class="card">
          <div class="card-header">
            <h2><span class="icon">üßç‚Äç‚ôÇÔ∏è</span> Ton h√©ros & stuff</h2>
            <div class="card-header-tag">Build & visuel</div>
          </div>
          <div class="card-body">
            <div class="avatar-wrapper">
              <div class="paperdoll-container">
                <div class="paperdoll" id="heroPaperdoll">
                  <svg class="avatar-svg" viewBox="0 0 120 160">
                    <!-- T√™te -->
                    <circle id="avatarHead" cx="60" cy="32" r="16"
                            fill="#fde7c5" stroke="#111827" stroke-width="2"></circle>
                    <!-- Bandeau (casque / couleur) -->
                    <rect id="avatarHeadband" x="48" y="26" width="24" height="6" rx="3"
                          fill="#111827"></rect>
                    <!-- Corps (t-shirt / manteau) -->
                    <rect id="avatarBody" x="40" y="50" width="40" height="40" rx="14"
                          fill="#f97316" stroke="#111827" stroke-width="2"></rect>
                    <!-- Bras -->
                    <rect id="avatarArmLeft" x="28" y="54" width="10" height="32" rx="5"
                          fill="#fde7c5" stroke="#111827" stroke-width="2"></rect>
                    <rect id="avatarArmRight" x="82" y="54" width="10" height="32" rx="5"
                          fill="#fde7c5" stroke="#111827" stroke-width="2"></rect>
                    <!-- Jambes / pantalon -->
                    <rect id="avatarLegLeft" x="44" y="92" width="12" height="28" rx="5"
                          fill="#111827" stroke="#111827" stroke-width="2"></rect>
                    <rect id="avatarLegRight" x="64" y="92" width="12" height="28" rx="5"
                          fill="#111827" stroke="#111827" stroke-width="2"></rect>
                    <!-- Chaussures -->
                    <rect id="avatarShoeLeft" x="42" y="120" width="16" height="6" rx="3"
                          fill="#020617" stroke="#020617" stroke-width="1"></rect>
                    <rect id="avatarShoeRight" x="62" y="120" width="16" height="6" rx="3"
                          fill="#020617" stroke="#020617" stroke-width="1"></rect>
                    <!-- Visage (emoji) -->
                    <text id="avatarFace" x="60" y="36" text-anchor="middle" font-size="14">üòé</text>
                  </svg>

                  <!-- Slots d‚Äô√©quipement autour du perso -->
                  <div class="doll-slot doll-slot-helmet" id="slot-helmet">üß¢</div>
                  <div class="doll-slot doll-slot-weapon" id="slot-weapon">ü•ä</div>
                  <div class="doll-slot doll-slot-armor" id="slot-armor">üß•</div>
                  <div class="doll-slot doll-slot-boots" id="slot-boots">üëü</div>
                  <div class="doll-slot doll-slot-accessory" id="slot-accessory">üíç</div>
                </div>
              </div>
              <div class="hero-summary">
                <div id="heroName"></div>
                <div class="hero-meta" id="heroMeta"></div>
                <button class="secondary" onclick="openCreationOverlay(true)">Modifier l'avatar</button>
              </div>
            </div>

            <div class="stat-list" id="heroStats"></div>

            <div class="hp-block">
              <div class="hp-label">
                <span>PV max</span>
                <span id="heroHPText">‚Äî</span>
              </div>
              <div class="hp-bar-outer">
                <div id="heroHPBarInner" class="hp-bar-inner"></div>
              </div>
            </div>

            <p style="margin-top:6px;font-size:12px;">
              Points de stats √† r√©partir : <span id="statPoints">0</span>
            </p>
            <div id="statButtons" style="margin-bottom:6px;"></div>

            <hr style="border:none;border-top:1px solid #e5e7eb;margin:6px 0;" />

            <div>
              <strong>√âquipement √©quip√© :</strong>
              <div id="equipment" style="margin-top:4px;"></div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2><span class="icon">üéí</span> Inventaire</h2>
            <div class="card-header-tag">Objets stock√©s</div>
          </div>
          <div class="card-body">
            <div id="inventoryList" style="font-size:13px;"></div>
            <div style="font-size:11px;color:#6b7280;margin-top:4px;">
              Ici sont stock√©s les objets que tu poss√®des mais qui ne sont pas √©quip√©s.
            </div>
          </div>
        </div>
      </section>

      <!-- √âCRAN 3 : BOUTIQUE -->
      <section id="section-shop" class="mobile-section">
        <div class="card">
          <div class="card-header">
            <h2><span class="icon">üõí</span> Boutique</h2>
            <div class="card-header-tag">Stats & √©quipement</div>
          </div>
          <div class="card-body">
            <button onclick="buyStatPoint()">+1 point de stats (30 pi√®ces)</button>
            <button class="secondary" onclick="buyRandomItem()">Caisse myst√®re (20 pi√®ces)</button>
            <button onclick="buyFixedItem('proGloves')">Gants pro (+3 FOR, +1 PRE) ‚Äì 40 pi√®ces</button>
            <button onclick="buyFixedItem('paddedJacket')">Blouson renforc√© (+4 VIT, +1 ESQ) ‚Äì 40 pi√®ces</button>
            <button onclick="buyFixedItem('champRing')">Bague √©pique (+2 PRE, +2 VITZ) ‚Äì 40 pi√®ces</button>
            <button onclick="refreshShop(true)">üîÅ Rafra√Æchir la boutique (5 pi√®ces)</button>
            <div id="shopInfo" class="shop-note">
              Utilise tes pi√®ces pour te renforcer. Les objets ont des raret√©s color√©es.
            </div>
            <div id="shopItemsList" class="shop-note" style="margin-top:8px;"></div>
          </div>
        </div>
      </section>

      <!-- √âCRAN 4 : QU√äTES + COSM√âTIQUES -->
      <section id="section-quests" class="mobile-section">
        <div class="card">
          <div class="card-header">
            <h2><span class="icon">‚è∞</span> Qu√™tes quotidiennes</h2>
            <div class="card-header-tag">Chaque jour</div>
          </div>
          <div class="card-body">
            <div id="dailyLoginBlock" style="margin-bottom:6px;"></div>
            <div id="dailyQuestsList" style="font-size:13px;"></div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2><span class="icon">‚úÖ</span> Carnet de d√©fis</h2>
            <div class="card-header-tag">Objectifs & r√©compenses</div>
          </div>
          <div class="card-body">
            <div id="achievementsList" style="font-size:13px;"></div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2><span class="icon">üé®</span> Cosm√©tiques</h2>
            <div class="card-header-tag">Skins & style</div>
          </div>
          <div class="card-body">
            <div id="cosmeticsList" style="font-size:13px;"></div>
            <div style="font-size:11px;color:#6b7280;margin-top:4px;">
              Certains skins se d√©bloquent via les d√©fis et l'ar√®ne.
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- NAV BAS -->
  <nav class="bottom-nav">
    <button id="nav-fight" class="nav-btn active" onclick="setMobileSection('fight')">
      <span class="icon">‚öîÔ∏è</span>
      <span>Combat</span>
    </button>
    <button id="nav-inventory" class="nav-btn" onclick="setMobileSection('inventory')">
      <span class="icon">üéí</span>
      <span>Inventaire</span>
    </button>
    <button id="nav-shop" class="nav-btn" onclick="setMobileSection('shop')">
      <span class="icon">üõí</span>
      <span>Boutique</span>
    </button>
    <button id="nav-quests" class="nav-btn" onclick="setMobileSection('quests')">
      <span class="icon">üìú</span>
      <span>Qu√™tes</span>
    </button>
  </nav>

  <!-- Bouton & panneau DEV -->
  <div id="devButton" class="dev-btn" onclick="toggleDevPanel()" title="Outils d√©veloppeur">
    üõ†Ô∏è
  </div>
  <div id="devPanel" class="dev-panel">
    <h3>Dev tools <span>(toi seulement üòè)</span></h3>
    <small>Raccourcis PC : Ctrl+Shift+C / M / G</small>
    <div>
      <button onclick="devAddCoins(100)">+100 pi√®ces</button>
      <button onclick="devMaxOut()">Maxer le h√©ros</button>
      <button onclick="devToggleGodMode()">Basculer GOD MODE</button>
    </div>
    <div style="margin-top:6px;">
      √âtat GOD MODE :
      <span id="devGodState" style="color:#ef4444;">INACTIF</span>
    </div>
  </div>

  <!-- OVERLAY CR√âATION / MODIF AVATAR -->
  <div id="creationOverlay" class="overlay hidden">
    <div class="overlay-inner">
      <h2>Cr√©e ton h√©ros</h2>
      <p>Choisis ton pseudo et la couleur de ton avatar.</p>
      <input id="createName" type="text" maxlength="16" placeholder="Ton pseudo" />

      <div class="color-row">
        <button type="button" class="color-choice selected"
                data-theme="orange"
                style="background:linear-gradient(135deg,#f97316,#facc15);"
                onclick="selectTheme('orange')"></button>
        <button type="button" class="color-choice"
                data-theme="green"
                style="background:linear-gradient(135deg,#22c55e,#4ade80);"
                onclick="selectTheme('green')"></button>
        <button type="button" class="color-choice"
                data-theme="blue"
                style="background:linear-gradient(135deg,#3b82f6,#38bdf8);"
                onclick="selectTheme('blue')"></button>
        <button type="button" class="color-choice"
                data-theme="purple"
                style="background:linear-gradient(135deg,#a855f7,#c084fc);"
                onclick="selectTheme('purple')"></button>
      </div>

      <button onclick="confirmCreation()">C'est parti !</button>
    </div>
  </div>

  <script>
    const DEV_MODE = true;
    const LEVEL_CAP = 30;
    let GOD_MODE = false;
    let currentCombatMode = "story";
    let selectedTheme = "orange";

    const AVATAR_THEMES = {
      orange: { torso: "#f97316", legs: "#ea580c" },
      green:  { torso: "#22c55e", legs: "#16a34a" },
      blue:   { torso: "#3b82f6", legs: "#1d4ed8" },
      purple: { torso: "#a855f7", legs: "#7e22ce" }
    };

    function getAvatarThemeColors(theme) {
      return AVATAR_THEMES[theme] || AVATAR_THEMES.orange;
    }

    function setMobileSection(id) {
      const sections = ["fight","inventory","shop","quests"];
      sections.forEach(sec => {
        const el = document.getElementById("section-" + sec);
        const btn = document.getElementById("nav-" + sec);
        if (!el) return;
        if (sec === id) {
          el.classList.add("active");
          if (btn) btn.classList.add("active");
        } else {
          el.classList.remove("active");
          if (btn) btn.classList.remove("active");
        }
      });
    }

    function setCombatMode(mode) {
      currentCombatMode = mode;
      const storyBtn = document.getElementById("mode-story");
      const arenaBtn = document.getElementById("mode-arena");
      const story = document.getElementById("storyControls");
      const arena = document.getElementById("arenaControls");
      if (!storyBtn || !arenaBtn || !story || !arena) return;

      if (mode === "story") {
        storyBtn.classList.add("active");
        arenaBtn.classList.remove("active");
        story.style.display = "";
        arena.style.display = "none";
      } else {
        storyBtn.classList.remove("active");
        arenaBtn.classList.add("active");
        story.style.display = "none";
        arena.style.display = "";
      }
    }

    function toggleDevPanel() {
      const panel = document.getElementById("devPanel");
      if (!panel) return;
      panel.classList.toggle("open");
    }

    function updateDevGodLabel() {
      const span = document.getElementById("devGodState");
      if (!span) return;
      span.textContent = GOD_MODE ? "ACTIF" : "INACTIF";
      span.style.color = GOD_MODE ? "#22c55e" : "#ef4444";
    }

    const slotEmojis = {
      weapon: "ü•ä",
      helmet: "üß¢",
      armor: "üß•",
      boots: "üëü",
      accessory: "üíç"
    };

    const RARITIES = [
      { id: "common",    name: "Commun",       color: "#9ca3af", weight: 40, statMult: 1.0 },
      { id: "uncommon",  name: "Peu commun",   color: "#22c55e", weight: 30, statMult: 1.3 },
      { id: "rare",      name: "Rare",         color: "#3b82f6", weight: 18, statMult: 1.6 },
      { id: "epic",      name: "√âpique",       color: "#a855f7", weight: 9,  statMult: 2.0 },
      { id: "legendary", name: "L√©gendaire",   color: "#ef4444", weight: 3,  statMult: 2.3 }
    ];

    const SKINS = {
      default: {
        id: "default",
        name: "Classique",
        face: "üòé",
        gradient: null
      },
      street: {
        id: "street",
        name: "Street Hero",
        face: "üòè",
        gradient: null
      },
      gold: {
        id: "gold",
        name: "Champion dor√©",
        face: "üòå",
        gradient: null
      }
    };

    const ACHIEVEMENTS = [
      { id: "story5",  name: "D√©but de carri√®re",     desc: "Gagner 5 missions histoire.",     type: "storyWins",  target: 5,  rewardCoins: 50 },
      { id: "story20", name: "Bourreau de quartier",  desc: "Gagner 20 missions histoire.",    type: "storyWins",  target: 20, rewardCoins: 120 },
      { id: "arena3",  name: "Rookie de l'ar√®ne",     desc: "Gagner 3 matchs d'ar√®ne.",        type: "arenaWins",  target: 3,  rewardCoins: 60,  unlockSkin: "street" },
      { id: "arena10", name: "Terreur du ladder",     desc: "Gagner 10 matchs d'ar√®ne.",       type: "arenaWins",  target: 10, rewardCoins: 150 },
      { id: "lvl5",    name: "Mont√©e en puissance",   desc: "Atteindre le niveau 5.",          type: "level",      target: 5,  rewardCoins: 40 },
      { id: "lvl10",   name: "Champion du bloc",      desc: "Atteindre le niveau 10.",         type: "level",      target: 10, rewardCoins: 80,  unlockSkin: "gold" },
      { id: "crit50",  name: "Grosse patate",         desc: "Mettre un crit d'au moins 50 d√©g√¢ts.", type: "bestCrit", target: 50, rewardCoins: 50 },
      { id: "rating200", name: "Respect du quartier", desc: "Atteindre 200 points d'ar√®ne.",   type: "arenaRating", target: 200, rewardCoins: 100 }
    ];

    const DAILY_QUESTS = [
      { id: "d_story3",  name: "Encha√Æner 3 missions", type: "storyWinsToday", target: 3,  rewardCoins: 30 },
      { id: "d_arena1",  name: "Gagner 1 match d'ar√®ne", type: "arenaWinsToday", target: 1, rewardCoins: 40 },
      { id: "d_crit30",  name: "Mettre un crit de 30+ d√©g√¢ts", type: "critToday", target: 30, rewardCoins: 30 }
    ];
    const DAILY_LOGIN_REWARD = 50;

    const baseHero = {
      name: "Champion",
      level: 1,
      xp: 0,
      xpToNext: 10,
      coins: 0,
      stats: { FOR: 7, VIT: 8, PRE: 5, ESQ: 3, VITZ: 4 },
      bonusStats: { FOR: 0, VIT: 0, PRE: 0, ESQ: 0, VITZ: 0 },
      statPoints: 0,
      equipment: {
        weapon:   { name: "Gants de boxe en mousse", FOR: 2, PRE: 1, rarityId: "common" },
        helmet:   { name: "Casquette retourn√©e", ESQ: 1,              rarityId: "common" },
        armor:    { name: "Hoodie rembourr√©",     VIT: 2,              rarityId: "common" },
        boots:    { name: "Baskets trou√©es",      VITZ: 1,             rarityId: "common" },
        accessory:{ name: "Cha√Æne en plastique dor√©", PRE: 1,          rarityId: "common" }
      },
      arena: { rating: 0, wins: 0, losses: 0 },
      progress: null,
      achievementsDone: null,
      cosmetics: null,
      shop: null,
      inventory: [],
      daily: null,
      appearance: null,
      meta: null
    };

    function loadHero() {
      const raw = localStorage.getItem("cca_hero");
      if (!raw) return null;
      try { return JSON.parse(raw); } catch { return null; }
    }
    function saveHero() { localStorage.setItem("cca_hero", JSON.stringify(hero)); }

    let hero = loadHero() || structuredClone(baseHero);
    let currentEnemy = null;
    let combatContext = null;
    let pendingLines = [];

    const heroMissTexts = [
      "Tu balances une patate dans le vent, il se baisse au dernier moment. üò¨",
      "Tu visais la t√™te‚Ä¶ tu touches l'air. Feinte involontaire. üòÖ",
      "Tu glisses un peu, ton coup part √† c√¥t√©. √áa arrive aux meilleurs. üôÉ"
    ];
    const heroHitTexts = [
      "Tu lui colles un bon coup pour {dmg} d√©g√¢ts. (PV ennemi : {hp})",
      "Tu le touches proprement : {dmg} d√©g√¢ts. (Il lui reste {hp} PV)",
      "Belle patate ! {dmg} d√©g√¢ts. (PV ennemis restants : {hp})"
    ];
    const heroCritTexts = [
      "COUP CRITIQUE dans le menton ! {dmg} d√©g√¢ts üí• (PV ennemi : {hp})",
      "Tu l'envoies presque au plafond : CRIT {dmg} d√©g√¢ts ! üí£ (PV ennemi : {hp})",
      "Grosse droite critique : {dmg} d√©g√¢ts ! (Il vacille, PV : {hp})"
    ];
    const enemyMissTexts = [
      "{name} tente un gros swing mais tu le regardes passer comme un spectateur. üòé",
      "{name} s'emm√™le les pieds, tu esquives sans forcer. üï∫",
      "{name} charge‚Ä¶ et tu n'es d√©j√† plus l√†. Esquive propre. üëü"
    ];
    const enemyHitTexts = [
      "{name} te place un coup pour {dmg} d√©g√¢ts. (Tes PV : {hp})",
      "{name} te touche, √ßa pique un peu : {dmg} d√©g√¢ts. (PV restants : {hp})",
      "{name} trouve l'ouverture et t'en colle une : {dmg} d√©g√¢ts. (Tes PV : {hp})"
    ];
    const enemyCritTexts = [
      "{name} te met une grosse mandale critique : {dmg} d√©g√¢ts ! üí• (Tes PV : {hp})",
      "A√Øe, crit dans les c√¥tes par {name} : {dmg} d√©g√¢ts‚Ä¶ (Tes PV : {hp})",
      "{name} te surprend avec un CRIT de {dmg} d√©g√¢ts ! (Tes PV : {hp})"
    ];
    const arenaNames = [
      "DarkNico", "CritMaster", "Tankito", "NoLifeur", "StreetLegend",
      "UppercutKing", "La Foudre", "LowLifePro", "MamadouFlex", "TapTapSpam"
    ];

    function rand(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

    function devAddCoins(amount = 100) {
      if (!DEV_MODE) return;
      hero.coins += amount;
      saveHero(); renderAll();
      log(`[DEV] +${amount} pi√®ces ajout√©es.`, "system");
      flushLogQueue();
    }
    function devMaxOut() {
      if (!DEV_MODE) return;
      hero.level = LEVEL_CAP;
      hero.xp = hero.xpToNext;
      hero.stats = { FOR: 50, VIT: 50, PRE: 40, ESQ: 30, VITZ: 35 };
      hero.coins = 99999;

      const legendary = RARITIES.find(r => r.id === "legendary");
      const slots = ["weapon","helmet","armor","boots","accessory"];
      slots.forEach(slot => {
        let data;
        do { data = generateRandomItem(legendary); } while (data.slot !== slot);
        hero.equipment[slot] = data.item;
      });

      hero.arena = hero.arena || { rating: 0, wins: 0, losses: 0 };
      hero.arena.rating = 500;
      hero.arena.wins = Math.max(hero.arena.wins || 0, 50);

      hero.progress = hero.progress || {};
      hero.progress.storyWins = Math.max(hero.progress.storyWins || 0, 50);
      hero.progress.arenaWins = Math.max(hero.progress.arenaWins || 0, 30);
      hero.progress.bestCrit = Math.max(hero.progress.bestCrit || 0, 150);
      hero.progress.maxLevel = LEVEL_CAP;
      hero.progress.arenaRatingBest = Math.max(hero.progress.arenaRatingBest || 0, hero.arena.rating || 0);

      if (hero.cosmetics) hero.cosmetics.unlocked = Object.keys(SKINS);
      if (!hero.appearance) hero.appearance = { theme: "orange" };

      saveHero(); renderAll();
      log("[DEV] H√©ros max√© : niveau, stats, l√©gendaires, ar√®ne et skins boost√©s.", "system");
      flushLogQueue();
    }
    function devToggleGodMode() {
      if (!DEV_MODE) return;
      GOD_MODE = !GOD_MODE;
      log(GOD_MODE
        ? "[DEV] GOD MODE activ√© : tu ne prends plus de d√©g√¢ts. üòà"
        : "[DEV] GOD MODE d√©sactiv√© : retour √† la normale.",
        "system");
      updateDevGodLabel();
      flushLogQueue();
    }
    document.addEventListener("keydown", (e) => {
      if (!DEV_MODE) return;
      const key = e.key.toLowerCase();
      if (e.ctrlKey && e.shiftKey && key === "c") devAddCoins(100);
      if (e.ctrlKey && e.shiftKey && key === "m") devMaxOut();
      if (e.ctrlKey && e.shiftKey && key === "g") devToggleGodMode();
    });

    let instantResolve = false;
    function toggleInstantResolve(cb) {
      instantResolve = cb.checked;
      log(
        instantResolve
          ? "Les combats seront r√©solus instantan√©ment."
          : "Les combats repassent en mode tour par tour.",
        "system"
      );
      flushLogQueue();
    }

    function todayStr() {
      return new Date().toISOString().slice(0,10);
    }

    function ensureDaily() {
      if (!hero.daily || !hero.daily.date || hero.daily.date !== todayStr()) {
        hero.daily = {
          date: todayStr(),
          loginClaimed: false,
          quests: {}
        };
        DAILY_QUESTS.forEach(q => {
          hero.daily.quests[q.id] = { progress: 0, done: false, claimed: false };
        });
      } else {
        if (!hero.daily.quests) hero.daily.quests = {};
        DAILY_QUESTS.forEach(q => {
          if (!hero.daily.quests[q.id]) {
            hero.daily.quests[q.id] = { progress: 0, done: false, claimed: false };
          }
        });
      }
    }

    function updateDailyProgress(type, amount, bestValue) {
      ensureDaily();
      DAILY_QUESTS.forEach(q => {
        const entry = hero.daily.quests[q.id];
        if (!entry) return;
        if (q.type !== type) return;

        if (type === "critToday") {
          entry.progress = Math.max(entry.progress, bestValue || 0);
        } else {
          entry.progress += amount || 0;
        }
        if (entry.progress >= q.target) entry.done = true;
      });
    }

    function claimDailyQuest(id) {
      ensureDaily();
      const entry = hero.daily.quests[id];
      const def = DAILY_QUESTS.find(q => q.id === id);
      if (!entry || !def) return;
      if (!entry.done || entry.claimed) return;
      entry.claimed = true;
      hero.coins += def.rewardCoins;
      log(`Qu√™te quotidienne valid√©e : ${def.name} (+${def.rewardCoins} pi√®ces).`, "loot");
      saveHero();
      renderAll();
      flushLogQueue();
    }

    function claimDailyLogin() {
      ensureDaily();
      if (hero.daily.loginClaimed) return;
      hero.daily.loginClaimed = true;
      hero.coins += DAILY_LOGIN_REWARD;
      log(`Bonus de connexion quotidien : +${DAILY_LOGIN_REWARD} pi√®ces.`, "loot");
      saveHero();
      renderAll();
      flushLogQueue();
    }

    function ensureStructures() {
      if (!hero.arena) hero.arena = { rating: 0, wins: 0, losses: 0 };
      if (!hero.progress) {
        hero.progress = {
          storyWins: 0,
          arenaWins: 0,
          bestCrit: 0,
          maxLevel: hero.level || 1,
          arenaRatingBest: hero.arena.rating || 0
        };
      }
      if (hero.progress.maxLevel == null) hero.progress.maxLevel = hero.level || 1;
      if (hero.progress.arenaRatingBest == null) hero.progress.arenaRatingBest = hero.arena.rating || 0;
      if (!hero.achievementsDone) hero.achievementsDone = {};
      if (!hero.cosmetics) hero.cosmetics = { currentSkin: "default", unlocked: ["default"] };
      if (!hero.cosmetics.unlocked || hero.cosmetics.unlocked.length === 0)
        hero.cosmetics.unlocked = ["default"];
      if (!hero.cosmetics.currentSkin) hero.cosmetics.currentSkin = "default";

      if (!hero.shop) hero.shop = { items: [], initialized: false };
      if (!hero.shop.items) hero.shop.items = [];
      if (hero.shop.initialized == null) hero.shop.initialized = false;
      if (!hero.shop.initialized) {
        hero.shop.items = [];
        for (let i = 0; i < 3; i++) hero.shop.items.push(generateShopOffer());
        hero.shop.initialized = true;
      }

      if (!hero.inventory) hero.inventory = [];
      if (hero.equipment) {
        for (const key of Object.keys(hero.equipment)) {
          const it = hero.equipment[key];
          if (it && !it.rarityId) it.rarityId = "common";
        }
      }

      if (!hero.appearance) hero.appearance = { theme: "orange" };
      if (!hero.meta) hero.meta = { created: false };

      ensureDaily();
      selectedTheme = hero.appearance.theme || "orange";
    }

    function getRarityById(id) {
      return RARITIES.find(r => r.id === id) || RARITIES[0];
    }
    function getTotalStat(stat) {
      let base = hero.stats[stat] || 0;
      let bonus = hero.bonusStats[stat] || 0;
      for (const slot of Object.values(hero.equipment)) {
        if (!slot) continue;
        if (slot[stat]) bonus += slot[stat];
      }
      return base + bonus;
    }
    function maxHP() { return getTotalStat("VIT") * 10; }

    function resetDuelBars() {
      document.getElementById("duelHeroHPText").textContent = "‚Äî";
      document.getElementById("duelEnemyHPText").textContent = "‚Äî";
      document.getElementById("duelHeroHPBar").style.width = "0%";
      document.getElementById("duelEnemyHPBar").style.width = "0%";
    }
    function updateDuelHP(heroHPValue, enemyHPValue) {
      if (!combatContext) return;
      const hBar = document.getElementById("duelHeroHPBar");
      const eBar = document.getElementById("duelEnemyHPBar");
      const hText = document.getElementById("duelHeroHPText");
      const eText = document.getElementById("duelEnemyHPText");

      const hMax = combatContext.heroMaxHP || maxHP();
      const eMax = combatContext.enemyMaxHP || (currentEnemy ? currentEnemy.VIT * 10 : 1);
      const h = Math.max(0, Math.min(heroHPValue ?? hMax, hMax));
      const e = Math.max(0, Math.min(enemyHPValue ?? eMax, eMax));

      hText.textContent = `${h} / ${hMax}`;
      eText.textContent = `${e} / ${eMax}`;
      hBar.style.width = ((h / hMax) * 100).toFixed(1) + "%";
      eBar.style.width = ((e / eMax) * 100).toFixed(1) + "%";
    }

    function clearLog() {
      document.getElementById("log").innerHTML = "";
      pendingLines = [];
    }
    function log(text, type = "system", heroHPValue = null, enemyHPValue = null) {
      pendingLines.push({ text, type, heroHP: heroHPValue, enemyHP: enemyHPValue });
    }
    function renderLogEntry(entry) {
      const el = document.getElementById("log");
      if (entry.text !== "") {
        const line = document.createElement("div");
        line.className = "log-line log-" + (entry.type || "system");
        line.textContent = entry.text;
        el.appendChild(line);
        el.scrollTop = el.scrollHeight;
      }
      if (entry.heroHP != null || entry.enemyHP != null) {
        updateDuelHP(entry.heroHP, entry.enemyHP);
      }
    }
    function playLogQueue(queue, done) {
      let i = 0;
      function step() {
        if (i >= queue.length) { if (done) done(); return; }
        const entry = queue[i++];
        renderLogEntry(entry);
        const delay = entry.type === "round" ? 450 : entry.type === "" ? 250 : 550;
        setTimeout(step, delay);
      }
      step();
    }
    function flushLogQueue(done) {
      const queue = pendingLines.slice();
      pendingLines = [];
      if (queue.length === 0) { if (done) done(); return; }
      if (instantResolve) {
        for (const entry of queue) renderLogEntry(entry);
        if (done) done();
      } else {
        playLogQueue(queue, done);
      }
    }

    function difficultyLabel(diff) {
      return diff === "easy" ? "facile" : diff === "normal" ? "normale" : "difficile";
    }
    function getArenaRankName(rating) {
      if (rating >= 1000) return "L√©gende";
      if (rating >= 600) return "Or";
      if (rating >= 300) return "Argent";
      if (rating >= 100) return "Bronze";
      return "Non class√©";
    }
    function getArenaRankEmoji(rating) {
      if (rating >= 1000) return "üèÜ";
      if (rating >= 600) return "ü•á";
      if (rating >= 300) return "ü•à";
      if (rating >= 100) return "ü•â";
      return "‚ö™";
    }

    function generateRandomItem(rarityOverride) {
      const slotPool = ["weapon", "helmet", "armor", "boots", "accessory"];
      const slot = slotPool[Math.floor(Math.random() * slotPool.length)];
      const baseNames = {
        weapon: ["Poing am√©ricain en plastique", "Bat gonflable", "Gants renforc√©s"],
        helmet: ["Casque de scooter ray√©", "Bandana serr√©", "Bonnet rembourr√©"],
        armor: ["Blouson matelass√©", "Gilet pare-choc", "Manteau √©pais"],
        boots: ["Sneakers de course", "Rangers urbaines", "Chaussures √† ressort"],
        accessory: ["Bague de champion", "Bracelet de sport", "Pendentif porte-bonheur"]
      };
      const name = baseNames[slot][Math.floor(Math.random() * baseNames[slot].length)];
      const rarity = rarityOverride || chooseRarity();
      const newItem = { name, rarityId: rarity.id };
      const statsKeys = ["FOR", "VIT", "PRE", "ESQ", "VITZ"];
      const nbStats = 1 + Math.floor(Math.random() * 3);
      for (let i = 0; i < nbStats; i++) {
        const s = statsKeys[Math.floor(Math.random() * statsKeys.length)];
        const baseVal = 1 + Math.floor(Math.random() * 3);
        const val = Math.max(1, Math.round(baseVal * rarity.statMult));
        newItem[s] = (newItem[s] || 0) + val;
      }
      return { slot, item: newItem, rarityId: rarity.id };
    }
    function chooseRarity() {
      const total = RARITIES.reduce((s, r) => s + r.weight, 0);
      let roll = Math.random() * total;
      for (const r of RARITIES) {
        if (roll < r.weight) return r;
        roll -= r.weight;
      }
      return RARITIES[0];
    }
    function itemScore(item) {
      let score = 0;
      for (const [k, v] of Object.entries(item)) {
        if (["FOR", "VIT", "PRE", "ESQ", "VITZ"].includes(k)) score += v;
      }
      return score;
    }

    function addItemToInventory(slot, item) {
      if (!hero.inventory) hero.inventory = [];
      hero.inventory.push({
        id: Date.now().toString() + Math.random().toString(16).slice(2),
        slot,
        item: structuredClone(item)
      });
    }
    function equipFromInventory(entryId) {
      const entry = hero.inventory.find(e => e.id === entryId);
      if (!entry) return;
      const slot = entry.slot;
      const newItem = entry.item;
      const current = hero.equipment[slot];
      hero.equipment[slot] = structuredClone(newItem);
      hero.inventory = hero.inventory.filter(e => e.id !== entryId);
      if (current) addItemToInventory(slot, current);
      saveHero(); renderAll();
      log(`Tu √©quipes ${newItem.name} depuis ton inventaire.`, "loot");
      flushLogQueue();
    }

    function buyStatPoint() {
      const cost = 30;
      const shopInfo = document.getElementById("shopInfo");
      if (hero.coins < cost) {
        log("Tu n'as pas assez de pi√®ces pour acheter un point de stats. (30 n√©cessaires)", "system");
        flushLogQueue();
        shopInfo.textContent = "Pas assez de pi√®ces pour un point de stats.";
        return;
      }
      hero.coins -= cost;
      hero.statPoints += 1;
      log(`Tu ach√®tes un point de stats pour ${cost} pi√®ces.`, "loot");
      shopInfo.textContent = "Point de stats achet√© ! Pense √† le d√©penser.";
      saveHero(); renderAll(); flushLogQueue();
    }

    function handleNewEquipment(slot, newItem, sourceLabel) {
      const current = hero.equipment[slot];
      if (!current) {
        hero.equipment[slot] = structuredClone(newItem);
        log(`${sourceLabel} : tu n'avais rien, tu √©quipes le nouvel objet.`, "loot");
        return;
      }
      const curScore = itemScore(current);
      const newScore = itemScore(newItem);
      log(`Objet actuel : ${current.name} (score ${curScore})`, "system");
      log(`Nouvel objet : ${newItem.name} (score ${newScore})`, "system");

      if (newScore > curScore) {
        hero.equipment[slot] = structuredClone(newItem);
        addItemToInventory(slot, current);
        log(`${sourceLabel} : tu √©quipes le nouvel objet, l'ancien va dans l'inventaire.`, "loot");
      } else {
        addItemToInventory(slot, newItem);
        log(`${sourceLabel} : tu gardes ton objet actuel, le nouveau va dans l'inventaire.`, "system");
      }
    }

    function buyRandomItem() {
      const cost = 20;
      const shopInfo = document.getElementById("shopInfo");
      if (hero.coins < cost) {
        log("Tu n'as pas assez de pi√®ces pour une caisse myst√®re (20 n√©cessaires).", "system");
        flushLogQueue();
        shopInfo.textContent = "Pas assez de pi√®ces pour la caisse myst√®re.";
        return;
      }
      hero.coins -= cost;
      const result = generateRandomItem();
      const slot = result.slot;
      const newItem = result.item;
      const rarity = getRarityById(result.rarityId);
      const emoji = slotEmojis[slot] || "üì¶";

      log("", "system");
      log(`üõí Caisse myst√®re : ${emoji} ${newItem.name} [${rarity.name}]`, "loot");
      handleNewEquipment(slot, newItem, "Caisse myst√®re");
      shopInfo.textContent = "Achat effectu√© ! √âquip√© ou rang√© dans l'inventaire.";
      saveHero(); renderAll(); flushLogQueue();
    }

    const fixedShop = {
      proGloves: {
        cost: 40,
        slot: "weapon",
        item: { name: "Gants pro", FOR: 3, PRE: 1, rarityId: "rare" }
      },
      paddedJacket: {
        cost: 40,
        slot: "armor",
        item: { name: "Blouson renforc√©", VIT: 4, ESQ: 1, rarityId: "uncommon" }
      },
      champRing: {
        cost: 40,
        slot: "accessory",
        item: { name: "Bague √©pique", PRE: 2, VITZ: 2, rarityId: "epic" }
      }
    };
    function buyFixedItem(key) {
      const offer = fixedShop[key];
      const shopInfo = document.getElementById("shopInfo");
      if (!offer) return;
      if (hero.coins < offer.cost) {
        log(`Pas assez de pi√®ces pour ${offer.item.name} (${offer.cost}).`, "system");
        flushLogQueue();
        shopInfo.textContent = "Pas assez de pi√®ces pour cet objet.";
        return;
      }
      hero.coins -= offer.cost;
      const slot = offer.slot;
      const newItem = structuredClone(offer.item);
      const rarity = getRarityById(newItem.rarityId || "common");
      const emoji = slotEmojis[slot] || "üì¶";

      log("", "system");
      log(`üõí Tu ach√®tes : ${emoji} ${newItem.name} [${rarity.name}]`, "loot");
      handleNewEquipment(slot, newItem, "Objet fixe");
      shopInfo.textContent = "Achat effectu√© (objet fixe).";
      saveHero(); renderAll(); flushLogQueue();
    }

    function generateShopOffer() {
      const res = generateRandomItem();
      const rarity = getRarityById(res.rarityId);
      const baseCostByRarity = {
        common: 20, uncommon: 28, rare: 40, epic: 60, legendary: 85
      };
      const cost = baseCostByRarity[rarity.id] || 25;
      return {
        id: Date.now().toString() + Math.random().toString(16).slice(2),
        slot: res.slot,
        item: res.item,
        rarityId: res.rarityId,
        cost
      };
    }
    function refreshShop(pay) {
      const shopInfo = document.getElementById("shopInfo");
      const refreshCost = 5;
      if (pay) {
        if (hero.coins < refreshCost) {
          log("Pas assez de pi√®ces pour rafra√Æchir la boutique (5 n√©cessaires).", "system");
          flushLogQueue();
          shopInfo.textContent = "Pas assez de pi√®ces pour rafra√Æchir.";
          return;
        }
        hero.coins -= refreshCost;
        log("Tu rafra√Æchis la boutique, de nouveaux √©quipements apparaissent.", "system");
      }
      hero.shop.items = [];
      for (let i = 0; i < 3; i++) hero.shop.items.push(generateShopOffer());
      hero.shop.initialized = true;
      saveHero(); renderAll(); flushLogQueue();
    }
    function buyShopOffer(id) {
      const idx = hero.shop.items.findIndex(o => o.id === id);
      if (idx < 0) return;
      const offer = hero.shop.items[idx];
      if (hero.coins < offer.cost) {
        log("Tu n'as pas assez de pi√®ces pour cet objet.", "system");
        flushLogQueue();
        return;
      }
      hero.coins -= offer.cost;
      const slot = offer.slot;
      const newItem = offer.item;
      const rarity = getRarityById(offer.rarityId);
      const emoji = slotEmojis[slot] || "üì¶";

      log("", "system");
      log(`üõí Tu ach√®tes : ${emoji} ${newItem.name} [${rarity.name}]`, "loot");
      handleNewEquipment(slot, newItem, "Boutique");
      hero.shop.items.splice(idx, 1);
      saveHero(); renderAll(); flushLogQueue();
    }

    function applyCurrentSkin() {
      const skin = SKINS[hero.cosmetics.currentSkin] || SKINS.default;
      const face = document.getElementById("avatarFace");
      const body = document.getElementById("avatarBody");
      const legL = document.getElementById("avatarLegLeft");
      const legR = document.getElementById("avatarLegRight");
      const themeColors = getAvatarThemeColors(hero.appearance.theme || "orange");

      if (face && skin.face) face.textContent = skin.face;
      if (body) body.setAttribute("fill", themeColors.torso);
      if (legL) legL.setAttribute("fill", themeColors.legs);
      if (legR) legR.setAttribute("fill", themeColors.legs);
    }

    function renderCosmetics() {
      const list = document.getElementById("cosmeticsList");
      if (!list) return;
      list.innerHTML = "";
      Object.values(SKINS).forEach(skin => {
        const unlocked = hero.cosmetics.unlocked.includes(skin.id);
        const isCurrent = hero.cosmetics.currentSkin === skin.id;
        const row = document.createElement("div");
        row.style.marginBottom = "4px";
        const icon = unlocked ? "üé®" : "üîí";
        row.innerHTML =
          `${icon} <strong>${skin.name}</strong>` +
          (isCurrent ? " ‚Äì (√âquip√©)" :
           unlocked ? " ‚Äì (Disponible)" : " ‚Äì (√Ä d√©bloquer)");
        if (unlocked && !isCurrent) {
          const btn = document.createElement("button");
          btn.textContent = "√âquiper";
          btn.style.marginLeft = "6px";
          btn.onclick = () => {
            hero.cosmetics.currentSkin = skin.id;
            saveHero(); applyCurrentSkin(); renderCosmetics(); updatePaperDollFromEquipment();
          };
          row.appendChild(btn);
        }
        list.appendChild(row);
      });
    }

    function checkAchievements() {
      ACHIEVEMENTS.forEach(def => {
        if (hero.achievementsDone[def.id]) return;
        let value = 0;
        switch (def.type) {
          case "storyWins":  value = hero.progress.storyWins || 0; break;
          case "arenaWins":  value = hero.progress.arenaWins || 0; break;
          case "level":      value = hero.progress.maxLevel || hero.level; break;
          case "bestCrit":   value = hero.progress.bestCrit || 0; break;
          case "arenaRating":value = hero.progress.arenaRatingBest || 0; break;
        }
        if (value >= def.target) {
          hero.achievementsDone[def.id] = true;
          if (def.rewardCoins) {
            hero.coins += def.rewardCoins;
            log(`D√©fi r√©ussi : ${def.name} ! R√©compense : +${def.rewardCoins} pi√®ces.`, "loot");
          }
          if (def.unlockSkin) {
            if (!hero.cosmetics.unlocked.includes(def.unlockSkin)) {
              hero.cosmetics.unlocked.push(def.unlockSkin);
              const skin = SKINS[def.unlockSkin];
              if (skin) log(`üé® Nouveau skin d√©bloqu√© : ${skin.name} !`, "loot");
            }
          }
        }
      });
    }

    function renderAchievements() {
      const list = document.getElementById("achievementsList");
      if (!list) return;
      list.innerHTML = "";
      ACHIEVEMENTS.forEach(def => {
        const done = !!hero.achievementsDone[def.id];
        let value = 0;
        switch (def.type) {
          case "storyWins":  value = hero.progress.storyWins || 0; break;
          case "arenaWins":  value = hero.progress.arenaWins || 0; break;
          case "level":      value = hero.progress.maxLevel || hero.level; break;
          case "bestCrit":   value = hero.progress.bestCrit || 0; break;
          case "arenaRating":value = hero.progress.arenaRatingBest || 0; break;
        }
        const icon = done ? "‚úÖ" : "‚¨ú";
        const row = document.createElement("div");
        row.style.marginBottom = "4px";
        row.textContent =
          `${icon} ${def.name} ‚Äì ${def.desc} (${Math.min(value, def.target)}/${def.target})`;
        list.appendChild(row);
      });
    }

    function renderDaily() {
      ensureDaily();
      const loginEl = document.getElementById("dailyLoginBlock");
      const list = document.getElementById("dailyQuestsList");
      if (!loginEl || !list) return;

      if (hero.daily.loginClaimed) {
        loginEl.innerHTML = `üéÅ Bonus quotidien d√©j√† r√©cup√©r√© (+${DAILY_LOGIN_REWARD} pi√®ces).`;
      } else {
        loginEl.innerHTML = `
          üéÅ Bonus quotidien disponible : +${DAILY_LOGIN_REWARD} pi√®ces.
          <br/>
          <button onclick="claimDailyLogin()">R√©cup√©rer</button>
        `;
      }

      list.innerHTML = "";
      DAILY_QUESTS.forEach(def => {
        const entry = hero.daily.quests[def.id];
        if (!entry) return;
        const icon = entry.done ? (entry.claimed ? "‚úÖ" : "‚òëÔ∏è") : "‚¨ú";
        const row = document.createElement("div");
        row.style.marginBottom = "4px";
        const progressText =
          def.type === "critToday"
            ? `${Math.min(entry.progress, def.target)}/${def.target} (meilleur crit du jour)`
            : `${Math.min(entry.progress, def.target)}/${def.target}`;
        row.innerHTML =
          `${icon} ${def.name} ‚Äì ${progressText} ‚Äì R√©compense : +${def.rewardCoins} pi√®ces`;
        if (entry.done && !entry.claimed) {
          const btn = document.createElement("button");
          btn.textContent = "R√©cup√©rer";
          btn.style.marginLeft = "6px";
          btn.onclick = () => claimDailyQuest(def.id);
          row.appendChild(btn);
        }
        list.appendChild(row);
      });
    }

    function renderHero() {
      const levelLabel =
        hero.level >= LEVEL_CAP ? `Niv. ${hero.level} (MAX)` : `Niv. ${hero.level} / ${LEVEL_CAP}`;
      document.getElementById("heroName").innerHTML =
        `<strong>${hero.name}</strong> <span class="badge">${levelLabel}</span>`;
      document.getElementById("heroMeta").textContent =
        `XP : ${hero.xp} / ${hero.xpToNext} ‚Ä¢ Pi√®ces : ${hero.coins}`;

      const statsEl = document.getElementById("heroStats");
      statsEl.innerHTML = "";
      const stats = ["FOR", "VIT", "PRE", "ESQ", "VITZ"];
      stats.forEach(stat => {
        const rowLabel = document.createElement("div");
        const rowVal = document.createElement("div");
        rowLabel.textContent =
          stat === "FOR" ? "Force" :
          stat === "VIT" ? "Vitalit√©" :
          stat === "PRE" ? "Pr√©cision" :
          stat === "ESQ" ? "Esquive" : "Vitesse";
        rowLabel.className = "label";
        rowVal.textContent = getTotalStat(stat);
        statsEl.appendChild(rowLabel);
        statsEl.appendChild(rowVal);
      });
      document.getElementById("statPoints").textContent = hero.statPoints;

      const fullHero = maxHP();
      document.getElementById("heroHPText").textContent = `${fullHero} / ${fullHero}`;
      document.getElementById("heroHPBarInner").style.width = "100%";

      const hudLevel = document.getElementById("hudLevel");
      const hudXP = document.getElementById("hudXP");
      const hudCoins = document.getElementById("hudCoins");
      if (hudLevel) hudLevel.textContent = levelLabel;
      if (hudXP) hudXP.textContent = `XP ${hero.xp}/${hero.xpToNext}`;
      if (hudCoins) hudCoins.textContent = `üí∞ ${hero.coins}`;
    }

    function renderStatButtons() {
      const container = document.getElementById("statButtons");
      container.innerHTML = "";
      const stats = [
        ["FOR", "Force"],
        ["VIT", "Vitalit√©"],
        ["PRE", "Pr√©cision"],
        ["ESQ", "Esquive"],
        ["VITZ", "Vitesse"]
      ];
      stats.forEach(([key, label]) => {
        const btn = document.createElement("button");
        btn.textContent = `+1 ${label}`;
        btn.disabled = hero.statPoints <= 0;
        btn.onclick = () => addStat(key);
        container.appendChild(btn);
      });
    }
    function addStat(statKey) {
      if (hero.statPoints <= 0) return;
      hero.stats[statKey] = (hero.stats[statKey] || 0) + 1;
      hero.statPoints -= 1;
      saveHero(); renderAll();
    }

    function renderEquipment() {
      const el = document.getElementById("equipment");
      const slots = [
        ["weapon", "Arme"],
        ["helmet", "Casque"],
        ["armor", "Armure"],
        ["boots", "Bottes"],
        ["accessory", "Accessoire"]
      ];
      el.innerHTML = "";
      slots.forEach(([key, label]) => {
        const item = hero.equipment[key];
        const div = document.createElement("div");
        div.style.marginBottom = "4px";
        const emoji = slotEmojis[key] || "üì¶";
        if (!item) {
          div.textContent = `${label} : (vide)`;
        } else {
          const rarity = getRarityById(item.rarityId || "common");
          const stats = Object.entries(item)
            .filter(([k]) => ["FOR","VIT","PRE","ESQ","VITZ"].includes(k))
            .map(([k, v]) => `${k}+${v}`)
            .join(", ");
          const nameBox =
            `<span style="
              display:inline-block;
              border-radius:6px;
              border:2px solid ${rarity.color};
              padding:0 6px;
              margin-right:4px;
              color:${rarity.color};
              font-weight:600;
            ">${item.name}</span>`;
          const statsSpan = stats
            ? ` <span style="font-size:11px;color:#555;">(${stats})</span>`
            : "";
          div.innerHTML = `<strong>${label}</strong> : ${emoji} ${nameBox}${statsSpan}`;
        }
        el.appendChild(div);
      });

      updatePaperDollFromEquipment();
    }

    function renderEnemy() {
      const infoEl = document.getElementById("enemyInfo");
      const statsEl = document.getElementById("enemyStats");
      const enemyHPText = document.getElementById("enemyHPText");
      const enemyHPBarInner = document.getElementById("enemyHPBarInner");

      if (!currentEnemy) {
        infoEl.textContent = "Aucun ennemi pour l'instant. Lance une mission ou un match d'ar√®ne.";
        statsEl.textContent = "";
        enemyHPText.textContent = "‚Äî";
        enemyHPBarInner.style.width = "0%";
        return;
      }
      infoEl.innerHTML = `<strong>${currentEnemy.name}</strong> (Niv. ${currentEnemy.level})`;
      statsEl.innerHTML =
        `<span class="pill">FOR ${currentEnemy.FOR}</span>` +
        `<span class="pill">VIT ${currentEnemy.VIT}</span>` +
        `<span class="pill">PRE ${currentEnemy.PRE}</span>` +
        `<span class="pill">ESQ ${currentEnemy.ESQ}</span>` +
        `<span class="pill">VITZ ${currentEnemy.VITZ}</span>`;

      const fullEnemy = currentEnemy.VIT * 10;
      enemyHPText.textContent = `${fullEnemy} / ${fullEnemy}`;
      enemyHPBarInner.style.width = "100%";
    }

    function renderArena() {
      const a = hero.arena || { rating: 0, wins: 0, losses: 0 };
      const arenaInfo = document.getElementById("arenaInfo");
      const rankName = getArenaRankName(a.rating);
      const rankEmoji = getArenaRankEmoji(a.rating);
      if (arenaInfo) {
        arenaInfo.innerHTML =
          `<div class="arena-rank">Rang : ${rankEmoji} ${rankName}` +
          `<span class="arena-rank-badge">${a.rating} pts</span></div>` +
          `<div style="font-size:12px;margin-top:2px;">Victoires : ${a.wins} ‚Ä¢ D√©faites : ${a.losses}</div>`;
      }

      const hudArena = document.getElementById("hudArena");
      if (hudArena) hudArena.textContent = `${rankEmoji} ${rankName}`;
    }

    function renderShop() {
      const list = document.getElementById("shopItemsList");
      if (!list) return;
      list.innerHTML = "";
      if (!hero.shop.items || hero.shop.items.length === 0) {
        list.textContent = "La boutique est vide. Rafra√Æchis pour voir de nouveaux objets.";
        return;
      }
      hero.shop.items.forEach(offer => {
        const rarity = getRarityById(offer.rarityId);
        const emoji = slotEmojis[offer.slot] || "üì¶";
        const statsText = Object.entries(offer.item)
          .filter(([k]) => ["FOR","VIT","PRE","ESQ","VITZ"].includes(k))
          .map(([k,v]) => `${k}+${v}`)
          .join(", ");
        const nameBox =
          `<span style="
            display:inline-block;
            border-radius:6px;
            border:2px solid ${rarity.color};
            padding:0 6px;
            margin-right:4px;
            color:${rarity.color};
            font-weight:600;
          ">${offer.item.name}</span>`;
        const statsSpan = statsText
          ? ` <span style="font-size:11px;color:#4b5563;">(${statsText})</span>`
          : "";
        const line = document.createElement("div");
        line.style.marginBottom = "4px";
        line.innerHTML =
          `${emoji} ${nameBox}${statsSpan} ‚Äì ` +
          `<span style="font-size:11px;">${offer.cost} pi√®ces</span>`;
        const btn = document.createElement("button");
        btn.textContent = "Acheter";
        btn.style.marginLeft = "6px";
        btn.onclick = () => buyShopOffer(offer.id);
        line.appendChild(btn);
        list.appendChild(line);
      });
    }

    function renderInventory() {
      const list = document.getElementById("inventoryList");
      if (!list) return;
      list.innerHTML = "";
      if (!hero.inventory || hero.inventory.length === 0) {
        list.textContent = "Ton inventaire est vide pour l'instant.";
        return;
      }
      hero.inventory.forEach(entry => {
        const { id, slot, item } = entry;
        const rarity = getRarityById(item.rarityId || "common");
        const emoji = slotEmojis[slot] || "üì¶";
        const statsText = Object.entries(item)
          .filter(([k]) => ["FOR","VIT","PRE","ESQ","VITZ"].includes(k))
          .map(([k,v]) => `${k}+${v}`)
          .join(", ");
        const slotLabel =
          slot === "weapon" ? "Arme" :
          slot === "helmet" ? "Casque" :
          slot === "armor" ? "Armure" :
          slot === "boots" ? "Bottes" : "Accessoire";
        const row = document.createElement("div");
        row.style.marginBottom = "4px";
        const nameBox =
          `<span style="
            display:inline-block;
            border-radius:6px;
            border:2px solid ${rarity.color};
            padding:0 6px;
            margin-right:4px;
            color:${rarity.color};
            font-weight:600;
          ">${item.name}</span>`;
        const statsSpan = statsText
          ? ` <span style="font-size:11px;color:#4b5563;">(${statsText})</span>`
          : "";
        row.innerHTML =
          `<span style="font-size:11px;color:#6b7280;">[${slotLabel}]</span> ` +
          `${emoji} ${nameBox}${statsSpan}`;
        const btn = document.createElement("button");
        btn.textContent = "√âquiper";
        btn.style.marginLeft = "6px";
        btn.onclick = () => equipFromInventory(id);
        row.appendChild(btn);
        list.appendChild(row);
      });
    }

    function updatePaperDollFromEquipment() {
      const themeColors = getAvatarThemeColors(hero.appearance.theme || "orange");
      const body = document.getElementById("avatarBody");
      const legL = document.getElementById("avatarLegLeft");
      const legR = document.getElementById("avatarLegRight");
      const shoeL = document.getElementById("avatarShoeLeft");
      const shoeR = document.getElementById("avatarShoeRight");
      const headband = document.getElementById("avatarHeadband");

      const slotHelmet = document.getElementById("slot-helmet");
      const slotWeapon = document.getElementById("slot-weapon");
      const slotArmor = document.getElementById("slot-armor");
      const slotBoots = document.getElementById("slot-boots");
      const slotAccessory = document.getElementById("slot-accessory");

      [slotHelmet, slotWeapon, slotArmor, slotBoots, slotAccessory].forEach(s => {
        if (s) s.style.borderColor = "#6b7280";
      });

      if (body) {
        body.setAttribute("fill", themeColors.torso);
        body.setAttribute("stroke", "#111827");
      }
      if (legL) {
        legL.setAttribute("fill", themeColors.legs);
        legL.setAttribute("stroke", "#111827");
      }
      if (legR) {
        legR.setAttribute("fill", themeColors.legs);
        legR.setAttribute("stroke", "#111827");
      }
      if (shoeL) {
        shoeL.setAttribute("stroke", "#020617");
      }
      if (shoeR) {
        shoeR.setAttribute("stroke", "#020617");
      }
      if (headband) {
        headband.setAttribute("fill", "#111827");
      }

      const eq = hero.equipment;

      if (eq.helmet) {
        const r = getRarityById(eq.helmet.rarityId || "common");
        if (slotHelmet) slotHelmet.style.borderColor = r.color;
        if (headband) headband.setAttribute("fill", r.color);
      }
      if (eq.armor) {
        const r = getRarityById(eq.armor.rarityId || "common");
        if (slotArmor) slotArmor.style.borderColor = r.color;
        if (body) body.setAttribute("stroke", r.color);
      }
      if (eq.boots) {
        const r = getRarityById(eq.boots.rarityId || "common");
        if (slotBoots) slotBoots.style.borderColor = r.color;
        if (shoeL) shoeL.setAttribute("stroke", r.color);
        if (shoeR) shoeR.setAttribute("stroke", r.color);
      }
      if (eq.weapon) {
        const r = getRarityById(eq.weapon.rarityId || "common");
        if (slotWeapon) {
          slotWeapon.style.borderColor = r.color;
          slotWeapon.textContent = "ü•ä";
        }
      } else if (slotWeapon) {
        slotWeapon.textContent = slotEmojis.weapon;
      }
      if (eq.accessory) {
        const r = getRarityById(eq.accessory.rarityId || "common");
        if (slotAccessory) {
          slotAccessory.style.borderColor = r.color;
          slotAccessory.textContent = "‚òÖ";
        }
      } else if (slotAccessory) {
        slotAccessory.textContent = slotEmojis.accessory;
      }

      applyCurrentSkin();
    }

    function renderAll() {
      ensureStructures();
      applyCurrentSkin();
      renderHero();
      renderStatButtons();
      renderEquipment();
      renderEnemy();
      renderArena();
      renderShop();
      renderInventory();
      renderCosmetics();
      renderAchievements();
      renderDaily();
      if (!combatContext || !combatContext.active) resetDuelBars();
      updateDevGodLabel();
      setCombatMode(currentCombatMode);
    }

    function startMission(difficulty) {
      clearLog();
      log(`Tu lances une mission ${difficultyLabel(difficulty)}...`, "system");

      const baseLevel = hero.level;
      let levelMod = difficulty === "easy" ? 0 : difficulty === "normal" ? 1 : 2;
      const enemyLevel = Math.max(1, baseLevel + levelMod);
      const enemy = generateEnemy(enemyLevel, difficulty);
      currentEnemy = enemy;
      renderEnemy();

      combatContext = { heroMaxHP: maxHP(), enemyMaxHP: enemy.VIT * 10, active: true };
      updateDuelHP(combatContext.heroMaxHP, combatContext.enemyMaxHP);

      log(`Adversaire : ${enemy.name} (Niv. ${enemy.level})`, "enemy");
      const result = simulateCombat(enemy);

      flushLogQueue(() => {
        endBattle("story", difficulty, enemy, result);
        flushLogQueue(() => {
          combatContext.active = false;
          saveHero();
          renderAll();
        });
      });
    }

    function generateEnemy(level, difficulty) {
      const namesEasy = ["Kevin le Ca√Ød", "Zozo du Parking", "Lulu le Relou"];
      const namesNormal = ["Bruno la Brute", "Momo du Quartier", "Sabrina la S√®che"];
      const namesHard = ["Rex le Colosse", "La Muraille", "Le Bulldozer"];
      let pool = difficulty === "easy" ? namesEasy : difficulty === "normal" ? namesNormal : namesHard;
      const name = pool[Math.floor(Math.random()*pool.length)];

      const hFOR = getTotalStat("FOR");
      const hVIT = getTotalStat("VIT");
      const hPRE = getTotalStat("PRE");
      const hESQ = getTotalStat("ESQ");
      const hVITZ = getTotalStat("VITZ");

      const params = {
        easy:   { hp: 0.7, for: 0.7, other: 0.8, maxForMult: 0.9 },
        normal: { hp: 1.0, for: 1.0, other: 1.0, maxForMult: 1.1 },
        hard:   { hp: 1.25, for: 1.1, other: 1.1, maxForMult: 1.3 }
      }[difficulty] || { hp: 1.0, for: 1.0, other: 1.0, maxForMult: 1.1 };

      function randAround(base, spread) {
        return Math.max(1, Math.round(base + (Math.random()*2 - 1)*spread));
      }

      let eFOR = randAround(hFOR * params.for, 1 + level);
      let eVIT = randAround(hVIT * params.hp, 1 + level);
      let ePRE = randAround(hPRE * params.other, 1 + Math.floor(level/2));
      let eESQ = randAround(hESQ * params.other, 1 + Math.floor(level/2));
      let eVITZ = randAround(hVITZ * params.other, 1 + Math.floor(level/2));

      const maxFOR = Math.max(2, Math.round(hFOR * params.maxForMult));
      if (eFOR > maxFOR) eFOR = maxFOR;

      return {
        name,
        level,
        FOR: eFOR,
        VIT: eVIT,
        PRE: Math.max(1, ePRE),
        ESQ: Math.max(1, eESQ),
        VITZ: Math.max(1, eVITZ)
      };
    }

    function startArenaBattle() {
      clearLog();
      log("Tu entres en match d'ar√®ne‚Ä¶ la foule est en d√©lire (dans ta t√™te). ü•ä", "system");

      const enemy = generateArenaEnemy();
      currentEnemy = enemy;
      renderEnemy();

      combatContext = { heroMaxHP: maxHP(), enemyMaxHP: enemy.VIT * 10, active: true };
      updateDuelHP(combatContext.heroMaxHP, combatContext.enemyMaxHP);

      log(`Adversaire d'ar√®ne : ${enemy.name} (Niv. ${enemy.level})`, "enemy");
      const result = simulateCombat(enemy);

      flushLogQueue(() => {
        endBattle("arena", null, enemy, result);
        flushLogQueue(() => {
          combatContext.active = false;
          saveHero();
          renderAll();
        });
      });
    }

    function generateArenaEnemy() {
      const rating = hero.arena?.rating || 0;
      const name = rand(arenaNames);
      const levelOffset = Math.floor(rating / 400);
      const level = Math.max(1, hero.level + levelOffset);

      const baseFactor = 0.85 + Math.min(rating, 600) / 600 * 0.15;
      function randAroundHero(statName, extraSpread = 0) {
        const base = getTotalStat(statName) * baseFactor;
        const spread = 1 + level + extraSpread;
        return Math.max(1, Math.round(base + (Math.random()*2 - 1)*spread));
      }

      let FOR = Math.max(1, Math.round(randAroundHero("FOR") * 0.95));
      let VIT = randAroundHero("VIT", 2);
      let PRE = Math.max(1, Math.round(randAroundHero("PRE") * 0.9));
      let ESQ = randAroundHero("ESQ");
      let VITZ = randAroundHero("VITZ");

      const heroFOR = getTotalStat("FOR");
      const maxFOR = Math.max(3, Math.round(heroFOR * 1.25));
      if (FOR > maxFOR) FOR = maxFOR;

      return { name, level, FOR, VIT, PRE, ESQ, VITZ };
    }

    function simulateCombat(enemy) {
      let heroHP = maxHP();
      let enemyHP = enemy.VIT * 10;
      log(`Tes PV : ${heroHP} ‚Ä¢ PV de ${enemy.name} : ${enemyHP}`, "system", heroHP, enemyHP);

      let round = 1;
      const maxRounds = 20;
      while (heroHP > 0 && enemyHP > 0 && round <= maxRounds) {
        log("", "system");
        log(`--- Round ${round} ---`, "round");

        const heroGoesFirst = getTotalStat("VITZ") >= enemy.VITZ;
        if (heroGoesFirst) {
          enemyHP = heroAttack(heroHP, enemyHP, enemy);
          if (enemyHP <= 0) break;
          heroHP = enemyAttack(heroHP, enemyHP, enemy);
        } else {
          heroHP = enemyAttack(heroHP, enemyHP, enemy);
          if (heroHP <= 0) break;
          enemyHP = heroAttack(heroHP, enemyHP, enemy);
        }
        round++;
      }

      if (GOD_MODE) {
        enemyHP = 0;
        log("", "system", heroHP, enemyHP);
        log("Gr√¢ce au GOD MODE, tu termines le combat en totale domination. üòà", "hero");
        return { outcome: "win", heroHP, enemyHP: 0 };
      }

      if (heroHP <= 0 && enemyHP <= 0) {
        log("", "system", heroHP, enemyHP);
        log("Match nul, vous tombez tous les deux K.O. üòµ", "system");
        return { outcome: "draw", heroHP: 0, enemyHP: 0 };
      } else if (heroHP <= 0) {
        log("", "system", heroHP, enemyHP);
        log("Tu es K.O. ü•¥", "enemy");
        return { outcome: "lose", heroHP: 0, enemyHP };
      } else if (enemyHP <= 0) {
        log("", "system", heroHP, enemyHP);
        log(`${enemy.name} est K.O., victoire ! ü•á`, "hero");
        return { outcome: "win", heroHP, enemyHP: 0 };
      } else {
        log("", "system", heroHP, enemyHP);
        log("Le combat se termine sans K.O. net.", "system");
        return { outcome: "draw", heroHP, enemyHP };
      }
    }

    function heroAttack(heroHP, enemyHP, enemy) {
      let hitChance = 0.75 + (getTotalStat("PRE") - enemy.ESQ) * 0.02;
      hitChance = Math.max(0.3, Math.min(0.97, hitChance));
      if (Math.random() > hitChance) {
        const txt = rand(heroMissTexts);
        log(txt, "hero", heroHP, enemyHP);
        return enemyHP;
      }
      const baseDamage = getTotalStat("FOR") * (0.9 + Math.random()*0.35);
      let critChance = 0.12 + getTotalStat("PRE") * 0.015;
      critChance = Math.max(0.05, Math.min(0.4, critChance));
      let dmg = Math.round(baseDamage);
      let crit = false;
      if (Math.random() < critChance) {
        crit = true;
        dmg = Math.round(dmg * 1.7);
        hero.progress.bestCrit = Math.max(hero.progress.bestCrit || 0, dmg);
        updateDailyProgress("critToday", 0, dmg);
      }
      enemyHP -= dmg;
      const hpStr = Math.max(0, enemyHP);
      if (crit) {
        let txt = rand(heroCritTexts).replace("{dmg}", dmg).replace("{hp}", hpStr);
        log(txt, "crit", heroHP, enemyHP);
      } else {
        let txt = rand(heroHitTexts).replace("{dmg}", dmg).replace("{hp}", hpStr);
        log(txt, "hero", heroHP, enemyHP);
      }
      return enemyHP;
    }

    function enemyAttack(heroHP, enemyHP, enemy) {
      if (GOD_MODE) {
        let txt = rand(enemyHitTexts)
          .replace("{name}", enemy.name)
          .replace("{dmg}", 0)
          .replace("{hp}", heroHP);
        log(txt + " (GOD MODE : aucun d√©g√¢t)", "hero", heroHP, enemyHP);
        return heroHP;
      }
      let hitChance = 0.7 + (enemy.PRE - getTotalStat("ESQ")) * 0.02;
      hitChance = Math.max(0.25, Math.min(0.9, hitChance));
      if (Math.random() > hitChance) {
        let txt = rand(enemyMissTexts).replace("{name}", enemy.name);
        log(txt, "hero", heroHP, enemyHP);
        return heroHP;
      }
      const baseDamage = enemy.FOR * (0.75 + Math.random()*0.3);
      let critChance = 0.08 + enemy.PRE * 0.012;
      critChance = Math.max(0.05, Math.min(0.3, critChance));
      let dmg = Math.round(baseDamage);
      let crit = false;
      if (Math.random() < critChance) {
        crit = true;
        dmg = Math.round(dmg * 1.6);
      }
      heroHP -= dmg;
      const hpStr = Math.max(0, heroHP);
      if (crit) {
        let txt = rand(enemyCritTexts).replace("{name}", enemy.name).replace("{dmg}", dmg).replace("{hp}", hpStr);
        log(txt, "crit", heroHP, enemyHP);
      } else {
        let txt = rand(enemyHitTexts).replace("{name}", enemy.name).replace("{dmg}", dmg).replace("{hp}", hpStr);
        log(txt, "enemy", heroHP, enemyHP);
      }
      return heroHP;
    }

    function endBattle(mode, difficulty, enemy, result) {
      if (mode === "story") {
        let baseXP = difficulty === "easy" ? 5 : difficulty === "normal" ? 9 : 14;
        let baseCoins = difficulty === "easy" ? 12 : difficulty === "normal" ? 20 : 32;

        if (result.outcome === "win") {
          log("", "system", result.heroHP, result.enemyHP);
          log(`R√©compenses : +${baseXP} XP, +${baseCoins} pi√®ces.`, "loot");
          hero.xp += baseXP;
          hero.coins += baseCoins;
          hero.progress.storyWins = (hero.progress.storyWins || 0) + 1;
          updateDailyProgress("storyWinsToday", 1, 0);
          maybeDropLoot(difficulty);
        } else if (result.outcome === "draw") {
          log("", "system", result.heroHP, result.enemyHP);
          log(`Tu apprends un peu : +${Math.round(baseXP/2)} XP.`, "loot");
          hero.xp += Math.round(baseXP/2);
        } else {
          log("", "system", result.heroHP, result.enemyHP);
          log("Pas de r√©compense cette fois-ci.", "system");
        }
      } else if (mode === "arena") {
        const a = hero.arena || (hero.arena = { rating: 0, wins: 0, losses: 0 });
        if (result.outcome === "win") {
          const xp = 8, coins = 15, gain = 20;
          log("", "system", result.heroHP, result.enemyHP);
          log(`Victoire en ar√®ne : +${xp} XP, +${coins} pi√®ces, +${gain} points d'ar√®ne.`, "loot");
          hero.xp += xp;
          hero.coins += coins;
          a.rating += gain;
          a.wins += 1;
          hero.progress.arenaWins = (hero.progress.arenaWins || 0) + 1;
          hero.progress.arenaRatingBest = Math.max(hero.progress.arenaRatingBest || 0, a.rating || 0);
          updateDailyProgress("arenaWinsToday", 1, 0);
        } else if (result.outcome === "lose") {
          const loss = 10;
          log("", "system", result.heroHP, result.enemyHP);
          log(`D√©faite en ar√®ne : -${loss} points d'ar√®ne.`, "system");
          a.rating = Math.max(0, a.rating - loss);
          a.losses += 1;
        } else {
          const xp = 4;
          log("", "system", result.heroHP, result.enemyHP);
          log(`Match nul en ar√®ne : +${xp} XP.`, "loot");
          hero.xp += xp;
        }
      }

      while (hero.xp >= hero.xpToNext && hero.level < LEVEL_CAP) {
        hero.xp -= hero.xpToNext;
        hero.level += 1;
        hero.xpToNext = Math.round(hero.xpToNext * 1.4);
        hero.statPoints += 3;
        hero.progress.maxLevel = Math.max(hero.progress.maxLevel || 0, hero.level);
        log("", "system");
        log(`üî• TU PASSES NIVEAU ${hero.level} ! Tu gagnes 3 points de stats.`, "loot");
      }
      if (hero.level >= LEVEL_CAP && hero.xp >= hero.xpToNext) {
        hero.xp = hero.xpToNext;
        log("", "system");
        log(`Tu es au niveau max (${LEVEL_CAP}).`, "system");
      }

      checkAchievements();
    }

    function maybeDropLoot(difficulty) {
      const roll = Math.random();
      const chance = difficulty === "easy" ? 0.25 : difficulty === "normal" ? 0.45 : 0.7;
      if (roll > chance) return;

      const res = generateRandomItem();
      const slot = res.slot;
      const newItem = res.item;
      const rarity = getRarityById(res.rarityId);
      const emoji = slotEmojis[slot] || "üì¶";

      log("", "system");
      log(`üíé Tu trouves un objet : ${emoji} ${newItem.name} [${rarity.name}]`, "loot");
      handleNewEquipment(slot, newItem, "Butin");
    }

    function openCreationOverlay(fromSettings) {
      const ov = document.getElementById("creationOverlay");
      const input = document.getElementById("createName");
      if (!ov) return;
      ov.classList.remove("hidden");
      if (input) input.value = hero.name || "";

      const theme = hero.appearance?.theme || "orange";
      selectedTheme = theme;
      document.querySelectorAll(".color-choice").forEach(btn => {
        const th = btn.getAttribute("data-theme");
        if (th === theme) btn.classList.add("selected");
        else btn.classList.remove("selected");
      });
    }

    function selectTheme(theme) {
      selectedTheme = theme;
      document.querySelectorAll(".color-choice").forEach(btn => {
        const th = btn.getAttribute("data-theme");
        if (th === theme) btn.classList.add("selected");
        else btn.classList.remove("selected");
      });
    }

    function confirmCreation() {
      const ov = document.getElementById("creationOverlay");
      const input = document.getElementById("createName");
      let name = (input?.value || "").trim();
      if (!name) name = "Champion";
      hero.name = name;
      hero.appearance = hero.appearance || {};
      hero.appearance.theme = selectedTheme || "orange";
      hero.meta = hero.meta || {};
      hero.meta.created = true;
      saveHero();
      renderAll();
      if (ov) ov.classList.add("hidden");
      clearLog();
      log(`Bienvenue ${hero.name} dans Cartoon Clash Arena !`, "system");
      flushLogQueue();
    }

    ensureStructures();
    renderAll();
    clearLog();
    updateDevGodLabel();
    setCombatMode("story");

    if (!hero.meta || !hero.meta.created) {
      openCreationOverlay(false);
      log("Bienvenue ! Commence par cr√©er ton h√©ros üëá", "system");
    } else {
      log(`Re-bienvenue ${hero.name} !`, "system");
    }
    flushLogQueue();
  </script>
</body>
</html>
